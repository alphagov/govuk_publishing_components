{"version":3,"file":"youtube-link-enhancement.js","sources":["../modules/youtube-link-enhancement.js"],"sourcesContent":["class YoutubeLinkEnhancement {\n  constructor($element, $classOverride) {\n    this.$element = $element\n    this.$classOverride = typeof $classOverride !== 'undefined' ? $classOverride : 'gem-c-govspeak__youtube-video'\n    window.apiScriptInserted = window.apiScriptInserted !== undefined ? window.apiScriptInserted : false\n    window.playerApiReady = window.playerApiReady !== undefined ? window.playerApiReady : false\n\n    // way to do the queued inserts from before but w/ window instead...\n    window.YoutubeQueuedInserts = (window.YoutubeQueuedInserts && window.YoutubeQueuedInserts.length) ? window.YoutubeQueuedInserts : [];\n    window.onYouTubePlayerAPIReady = window.onYouTubePlayerAPIReady || function () {\n      window.playerApiReady = true\n      for (var i = 0; i < window.YoutubeQueuedInserts.length; i++) {\n        window.YoutubeQueuedInserts[i].call()\n      }\n    }    \n  }\n\n  init() {\n    if (!this.campaignCookiesAllowed()) {\n      this.startModule = this.startModule.bind(this)\n      window.addEventListener('cookie-consent', this.startModule)\n      return\n    }\n    this.startModule()\n  }\n\n  startModule() {\n    window.removeEventListener('cookie-consent', this.startModule)\n    var $youtubeLinks = this.$element.querySelectorAll('a[href*=\"youtube.com\"], a[href*=\"youtu.be\"]')\n\n    if ($youtubeLinks.length > 0) {\n      this.insertApiScript()\n    }\n\n    for (var i = 0; i < $youtubeLinks.length; ++i) {\n      var $link = $youtubeLinks[i]\n      var href = $link.getAttribute('href')\n      var hasTracking = $link.hasAttribute('data-youtube-player-analytics')\n      var options = {\n        link: $link\n      }\n\n      if (hasTracking) {\n        options.tracking = {\n          hasTracking: hasTracking,\n          category: $link.getAttribute('data-youtube-player-analytics-category')\n        }\n      }\n\n      if (href.indexOf('/live_stream') >= 0) {\n        var channelId = this.parseLivestream(href)\n\n        if (!this.hasDisabledEmbed($link) && channelId) {\n          options.channel = channelId\n          this.setupVideo(options)\n        }\n      } else {\n        var videoId = this.parseVideoId(href)\n        if (!this.hasDisabledEmbed($link) && videoId) {\n          options.videoId = videoId\n          this.setupVideo(options)\n        }\n      }\n    }\n  }\n\n  hasDisabledEmbed($link) {\n    return $link.getAttribute('data-youtube-player') === 'off'\n  }\n\n  setupVideo(options) {\n    var elementId = this.nextId()\n    var $link = options.link\n\n    var id = options.videoId ? options.videoId : options.channel\n\n    var parentPara = $link.parentNode\n    var parentContainer = parentPara.parentNode\n\n    var youtubeVideoContainer = document.createElement('div')\n    youtubeVideoContainer.className += this.$classOverride\n    youtubeVideoContainer.innerHTML = '<span id=\"' + elementId + '\" data-video-id=\"' + id + '\"></span>'\n\n    options.title = $link.textContent\n\n    parentContainer.replaceChild(youtubeVideoContainer, parentPara)\n    this.insertVideo(elementId, options)\n  }\n\n  insertVideo(elementId, options) {\n    var channelId = ''\n    var videoId = ''\n\n    if (options.channel) {\n      channelId = options.channel\n      videoId = 'live_stream'\n    } else {\n      videoId = options.videoId\n    }\n\n    var videoInsert = function () {\n      new window.YT.Player(elementId, { // eslint-disable-line no-new\n        videoId: videoId,\n        host: 'https://www.youtube-nocookie.com',\n        playerVars: {\n          // enables the player to be controlled via IFrame or JavaScript Player API calls\n          enablejsapi: 1,\n          origin: window.location.origin,\n          // don't show related videos\n          rel: 0,\n          // disable option to allow single key shortcuts due to (WCAG SC 2.1.4)\n          // https://www.w3.org/WAI/WCAG21/quickref/#character-key-shortcuts\n          disablekb: 1,\n          // prevent the YouTube logo from displaying in the control bar\n          modestbranding: 1,\n          // To support live_stream videos\n          channel: channelId\n        },\n        events: {\n          onReady: function (event) {\n            // update iframe title attribute once video is ready\n            // this is done to let screen reader users know that they are focused on a video\n            // https://github.com/alphagov/govuk_publishing_components/pull/908#discussion_r302913995\n            var videoTitle = options.title\n            event.target.getIframe().title = videoTitle + ' (video)'\n          },\n          onStateChange: function (event) {\n            var eventData = event.data\n            var eventTarget = event.target\n            var states = {\n              /* eslint-disable quote-props */\n              '-1': 'VideoUnstarted',\n              '0': 'VideoEnded',\n              '1': 'VideoPlaying',\n              '2': 'VideoPaused',\n              '3': 'VideoBuffering',\n              '5': 'VideoCued'\n              /* eslint-enable */\n            }\n            if (states[eventData] && options.tracking && options.tracking.hasTracking &&\n                window.GOVUK.analytics && window.GOVUK.analytics.trackEvent) {\n              var tracking = {\n                category: options.tracking.category,\n                action: states[eventData],\n                label: { transport: 'beacon', label: eventTarget.getVideoData && eventTarget.getVideoData().title }\n              }\n\n              window.GOVUK.analytics.trackEvent(tracking.category, tracking.action, tracking.label)\n            }\n          }\n        }\n      })\n    }\n\n    videoInsert = videoInsert.bind(this)\n\n    if (window.playerApiReady) {\n      videoInsert.call()\n    } else {\n      window.YoutubeQueuedInserts.push(videoInsert)\n    }\n  }\n\n  campaignCookiesAllowed() {\n    var cookiePolicy = window.GOVUK.getConsentCookie()\n    return cookiePolicy !== null ? cookiePolicy.campaigns : true\n  }\n\n  nextId() {\n    this.embedCount = this.embedCount || 0\n    this.embedCount += 1\n    return 'youtube-' + this.embedCount\n  }\n\n  insertApiScript() {\n    if (window.apiScriptInserted) {\n      return\n    }\n\n    var tag = document.createElement('script')\n    tag.src = 'https://www.youtube.com/player_api'\n    var firstScriptTag = document.getElementsByTagName('script')[0]\n    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag)\n    window.apiScriptInserted = true\n  }\n\n  parseLivestream(url) {\n    var matches = url.match(/channel=([^&]*)/)\n\n    if (matches) {\n      return matches[1]\n    }\n  }\n\n  // This is a public class method so it can be used outside of this embed to\n  // check that user input for videos will be supported in govspeak\n  parseVideoId(url) {\n    var parts\n\n    if (url.indexOf('youtube.com') > -1) {\n      var params = {}\n      parts = url.split('?')\n      if (parts.length === 1) {\n        return\n      }\n      parts = parts[1].split('&')\n      for (var i = 0; i < parts.length; i++) {\n        var part = parts[i].split('=')\n        params[part[0]] = part[1]\n      }\n      return params.v\n    } else if (url.indexOf('youtu.be') > -1) {\n      parts = url.split('/')\n      return parts.pop()\n    }\n  }\n}\n\nexport default YoutubeLinkEnhancement;\n"],"names":[],"mappings":"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"}