<%
  add_gem_component_stylesheet("chart")
  add_gem_component_stylesheet("table")
  add_gem_component_stylesheet("details")
  add_gem_component_stylesheet("heading")
  add_gem_component_stylesheet("skip-link")

  chart_heading ||= nil
  chart_heading_level ||= 2
  table_direction ||= "horizontal"
  local_assigns[:h_axis_title] ||= nil
  local_assigns[:v_axis_title] ||= nil
  local_assigns[rows] ||= []
  local_assigns[keys] ||= []
  chart_overview ||= nil
  local_assigns[:minimal] ||= false
  hide_heading ||= local_assigns[:minimal]
  local_assigns[:hide_legend] ||= local_assigns[:minimal]
  link ||= false
  local_assigns[:height] ||= 400
  padding ||= false
  local_assigns[:point_size] ||= 10
  y_axis_auto_adjust ||= false
  local_assigns[:line_width] ||= 2
  line_colours ||= nil
  line_styles ||= nil
  chart_type ||= "line"

  chart_id = "chart-id-#{SecureRandom.hex(4)}"
  table_id = "table-id-#{SecureRandom.hex(4)}"
  @external_script ||= OpenStruct.new(loaded: 0)
  @external_script[:loaded] += 1

  chart_helper = GovukPublishingComponents::Presenters::ChartHelper.new(local_assigns)
  shared_helper = GovukPublishingComponents::Presenters::SharedHelper.new(local_assigns)
  component_helper = GovukPublishingComponents::Presenters::ComponentWrapperHelper.new(local_assigns)
  component_helper.add_class("gem-c-chart")
  component_helper.add_class(shared_helper.get_margin_bottom)
  component_helper.add_class("gem-c-chart--minimal") if local_assigns[:minimal]
  component_helper.add_class("gem-c-chart--padding") if padding

  require "chartkick"
  Chartkick.options[:html] = '<div id="%{id}"></div>'
  Chartkick.options[:html] = '<div id="%{id}"><noscript><p class="govuk-body">Our charts are built using JavaScript but all the data is also available in the table beloww.</p></noscript></div>' unless local_assigns[:minimal]

  if !local_assigns[:minimal] && !chart_heading
    raise ArgumentError, "A chart heading must be provided for accessibility purposes."
  end
%>
<% if local_assigns[:rows].length > 0 && local_assigns[:keys].length > 0 %>
  <%= javascript_include_tag "https://www.gstatic.com/charts/loader.js" if @external_script[:loaded] == 1 %>
  <%= tag.div(**component_helper.all_attributes) do %>
    <% if chart_heading && !hide_heading %>
      <div class="gem-c-chart__header">
        <%= render "govuk_publishing_components/components/heading", {
          text: chart_heading,
          heading_level: chart_heading_level,
          margin_bottom: 2,
        } %>
      </div>
    <% end %>

    <% aria_attributes = { hidden: true } if local_assigns[:minimal] %>
    <%= content_tag :div, id: chart_id, class: "gem-c-chart__chart", aria: aria_attributes do %>
      <% unless local_assigns[:minimal] %>
        <div class="govuk-visually-hidden">
          <%= content_tag :div, chart_overview, class: "gem-c-chart__a11y-note-1" if chart_overview %>
          <%= content_tag :div, t("components.chart.accessibility_html"), class: "gem-c-chart__a11y-note-2" %>
        </div>
        <span class="gem-c-chart__a11y-note-link">
          <%= render "govuk_publishing_components/components/skip_link", {
            text: t("components.chart.accessibility_link", chart_heading: chart_heading),
            href: "##{table_id}"
          } %>
        </span>
      <% end %>

      <% if chart_type == "column" %>
        <%= column_chart(chart_helper.chart_format_data, library: chart_helper.chart_options) %>
      <% elsif chart_type == "bar" %>
        <%= bar_chart(chart_helper.chart_format_data, library: chart_helper.chart_options) %>
      <% else %>
        <%= line_chart(chart_helper.chart_format_data, library: chart_helper.chart_options) %>
      <% end %>
    <% end %>

    <% unless local_assigns[:minimal] %>
      <div class="gem-c-chart__footer">
        <div class="gem-c-chart__table" id="<%= table_id %>">
          <%= render("govuk_publishing_components/components/details",
            title: t("components.chart.table_dropdown")
          ) do %>
            <div tabindex="0" class="gem-c-chart__table-wrapper">
              <table class="govuk-table">
                <caption class="govuk-visually-hidden" id="<%= "data-table-caption-#{SecureRandom.hex(4)}" %>">
                  <%= t("components.chart.accessibility_heading", chart_heading: chart_heading) %>
                </caption>
                <% if table_direction == "horizontal" %>
                  <thead class="govuk-table__head">
                    <tr class="govuk-table__row">
                      <td class="govuk-table__cell"></td>
                      <% local_assigns[:keys].each do |key| %>
                        <th class="govuk-table__header" scope="col">
                          <%= key %>
                        </th>
                      <% end %>
                    </tr>
                  </thead>
                  <tbody class="govuk-table__body">
                    <% local_assigns[:rows].each do |row| %>
                      <tr class="govuk-table__row">
                        <th class="govuk-table__header" scope="row"><%= row[:label]  %></th>
                        <% row[:values].each do |value| %>
                          <td class="govuk-table__cell govuk-table__cell--numeric">
                            <%= number_with_delimiter value %>
                          </td>
                        <% end %>
                      </tr>
                    <% end %>
                  </tbody>
                <% else %>
                  <thead class="govuk-table__head">
                    <tr class="govuk-table__row">
                      <td class="govuk-table__cell"></td>
                      <% local_assigns[:rows].each do |row| %>
                        <th class="govuk-table__header govuk-table__header--stacked" scope="row">
                          <%= row[:label] %>
                        </th>
                      <% end %>
                    </tr>
                  </thead>
                  <tbody class="govuk-table__body">
                    <% local_assigns[:keys].each_with_index do |key, index| %>
                      <tr>
                        <th class="govuk-table__header" scope="row">
                          <%= key %>
                        </th>
                        <% local_assigns[:rows].each do |row| %>
                          <td class="govuk-table__cell govuk-table__cell--numeric">
                            <%= number_with_delimiter row[:values][index] %>
                          </td>
                        <% end %>
                      </tr>
                    <% end %>
                  </tbody>
                <% end %>
              </table>
            </div>
          <% end %>
        </div>

        <% if link %>
          <p class="govuk-body">
            <%= link_to "Download chart data", link,  class: "govuk-link" %>
          </p>
        <% end %>
      </div>
    <% end %>
  <% end %>
<% end %>
