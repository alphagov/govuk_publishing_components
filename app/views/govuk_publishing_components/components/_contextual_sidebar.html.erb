<%
  ga4_tracking ||= false
  @ga4_tracking_counts = OpenStruct.new(section_index: 1, link_count: 0)
  navigation = GovukPublishingComponents::Presenters::ContextualNavigation.new(content_item, request)
  related_nav_helper = GovukPublishingComponents::Presenters::RelatedNavigationHelper.new({ content_item: content_item, context: :sidebar, ga4_tracking: ga4_tracking })
  @ga4_tracking_counts.link_count += related_nav_helper.total_links
  shared_helper = GovukPublishingComponents::Presenters::SharedHelper.new(local_assigns)
%>
<div class="gem-c-contextual-sidebar">
  <p>CS counts: <%= @ga4_tracking_counts.inspect %>
  <% if navigation.content_tagged_to_a_reasonable_number_of_step_by_steps? %>
    <%# Rendering step by step related items because there are a few but not too many of them %>
    <%= render 'govuk_publishing_components/components/step_by_step_nav_related', links: navigation.step_nav_helper.related_links %>
    <% @ga4_tracking_counts.link_count += navigation.step_nav_helper.related_links.count %>
    <% @ga4_tracking_counts.section_index += 1 %>
  <% end %>

  <% if navigation.content_tagged_to_current_step_by_step? %>
    <%# Rendering step by step sidebar because there's 1 step by step list %>
    <%= render 'govuk_publishing_components/components/step_by_step_nav', navigation.step_nav_helper.sidebar %>
    <% @ga4_tracking_counts.section_index += 1 %>
  <% else %>
    <%# Rendering related navigation sidebar because no step by step list %>
    <% local_assigns[:in_contextual_sidebar] = true %>
    <%= render 'govuk_publishing_components/components/related_navigation', local_assigns %>
  <% end %>

  <% if navigation.content_tagged_to_other_step_by_steps? %>
    <%# Rendering step by step related items because there are a few but not too many of them %>
    <%= render 'govuk_publishing_components/components/step_by_step_nav_related', {
      pretitle: t("components.contextual_sidebar.pretitle"),
      links: navigation.step_nav_helper.also_part_of_step_nav,
      always_display_as_list: true
    } %>
    <% @ga4_tracking_counts.section_index += 1 %>
  <% end %>

  <% if navigation.show_ukraine_cta %>
    <%= render 'govuk_publishing_components/components/contextual_sidebar/ukraine_cta', content_item: content_item, ga4_tracking: ga4_tracking, link_count: navigation.total_links %>
  <% end %>
  <p>CS counts: <%= @ga4_tracking_counts.inspect %>
</div>
