<%
  groups ||= false
  small ||= false
  heading_level ||= 2
  show_step ||= false
  remember_last_step ||= false
  task_list_url ||= false
  task_list_url_link_text ||= "Get help completing this step"
  highlight_group ||= false

  step_count = 0
%>
<% if groups %>
  <div
    data-module="gemtasklist"
    class="gem-c-task-list js-hidden <% unless small %>gem-c-task-list--large<% end %>"
    <% if remember_last_step %>data-remember<% end %>
    >
    <ol class="gem-c-task-list__groups">
      <% groups.each_with_index do |group, group_index| %>
        <%
          group_is_active = group_index + 1 == highlight_group
        %>
        <li class="gem-c-task-list__group <%= 'gem-c-task-list__group--active' if group_is_active %>" <% if group_is_active %>aria-current="step"<% end %>>
          <span class="gem-c-task-list__circle gem-c-task-list__circle--number">
            <span class="gem-c-task-list__circle-inner">
              <span class="gem-c-task-list__circle-background">
                <span class="visuallyhidden">Step</span> <%= group_index + 1 %>
              </span>
            </span>
          </span>

          <% group.each_with_index do |step, step_index| %>
            <%
              step_count += 1
              id = generate_id(step[:title])

              logic = "and"
              logic = step[:logic] if ["and", "or"].include? step[:logic]
            %>
            <div
              class="gem-c-task-list__step js-step <%= "gem-c-task-list__step--optional" if step[:optional] %>"
              id="<%= id %>"
              data-track-count="tasklistSection"
              <%= "data-show" if step_count == show_step %>
              >
              <% if step_index > 0 %>
                <div class="gem-c-task-list__circle gem-c-task-list__circle--logic">
                  <span class="gem-c-task-list__circle-inner">
                    <span class="gem-c-task-list__circle-background">
                      <%= logic %>
                    </span>
                  </span>
                </div>
              <% end %>

              <div class="gem-c-task-list__header js-toggle-panel" data-position="<%= "#{group_index + 1}.#{step_index + 1}" %>">
                <h<%= heading_level %> class="gem-c-task-list__title js-step-title">
                  <%= step[:title] %>
                </h<%= heading_level %>>
              </div>

              <div class="gem-c-task-list__panel js-panel" id="step-panel-<%= id %>-<%= step_index + 1 %>">
                <%
                  in_substep = false
                  link_index = 0
                %>
                <% step[:contents].each do |element| %>
                  <% if element[:type] == 'paragraph' %>
                    <%= content_tag("p", element[:text], class: 'gem-c-task-list__paragraph') %>

                  <% elsif element[:type] == 'heading' %>
                    <%= content_tag("h#{heading_level + 1}", element[:text], class: 'gem-c-task-list__heading') %>

                  <% elsif element[:type] == 'list' %>
                    <%
                      list_style = ''
                      list_element = 'ol'

                      if element[:style] == 'required'
                        list_style = 'gem-c-task-list__links--required'
                      elsif element[:style] == 'choice'
                        list_style = 'gem-c-task-list__links--choice'
                        list_element = 'ul'
                      end
                    %>

                    <%= content_tag(
                      list_element,
                      class: "gem-c-task-list__links #{list_style}",
                      data: {
                        length: element[:contents].length
                      }) do %>
                      <% element[:contents].each do |link| %>
                        <%
                          if link[:href]
                            link_href = link[:active] ? "#content" : link[:href]
                            link_text = link[:active] ? '<span class="visuallyhidden">You are currently viewing:</span> '.html_safe + link[:text] : link[:text]
                            link_active = 'gem-c-task-list__link-item--active' if link[:active]
                            link_rel = link_href.start_with?('http') ? 'rel=external' : ''
                            link_index += 1
                            link_position = "data-position=\"#{group_index + 1}.#{step_index + 1}.#{link_index}\""

                            link_tag = "<a href=\"#{link_href}\" class=\"gem-c-task-list__link-item js-link #{link_active}\" #{link_position} #{link_rel}>#{link_text}</a>".html_safe
                          else
                            link_tag = link[:text]
                          end
                        %>
                        <li class="gem-c-task-list__link">
                          <%= link_tag %>

                          <% if link[:context] %>
                            <span class="gem-c-task-list__context"><%= link[:context] %></span>
                          <% end %>
                        </li>
                      <% end %>
                    <% end %>

                  <% elsif element[:type] == 'substep' %>
                    <% if in_substep %>
                      </div>
                      <% in_substep = false %>
                    <% end %>
                    <div class="gem-c-task-list__substep <% if element[:optional] %>gem-c-task-list__substep--optional<% end %>">
                    <% in_substep = true %>
                  <% end %>
                <% end %>

                <% if in_substep %>
                  </div>
                <% end %>

                <% if task_list_url && step[:show_help_link] %>
                  <div class="gem-c-task-list__help">
                    <a href="<%= task_list_url %>#<%= id %>" class="gem-c-task-list__help-link js-link" data-position="get-help"><%= task_list_url_link_text %></a>
                  </div>
                <% end %>
              </div>

            </div>
          <% end %>
        </li>
      <% end %>
    </ol>
  </div>
<% end %>
